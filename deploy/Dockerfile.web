# Stage 1: Build the frontend application
FROM docker.m.daocloud.io/library/node:20-alpine AS builder

WORKDIR /app

ENV NPM_CONFIG_UPDATE_NOTIFIER=false \
    NPM_CONFIG_FUND=false

COPY frontend/package.json frontend/package-lock.json ./
RUN npm config set registry https://registry.npmmirror.com
RUN npm ci

COPY frontend/ /app

ARG VITE_API_BASE=/api/v1
ENV VITE_API_BASE=${VITE_API_BASE}

RUN npm run build

# Stage 2: Nginx runtime
FROM docker.m.daocloud.io/library/nginx:1.27-alpine

ARG HTTP_ONLY="false"
ARG BUILD_TIMESTAMP="unknown"
ENV HTTP_ONLY=${HTTP_ONLY} \
    BUILD_TIMESTAMP=${BUILD_TIMESTAMP}

WORKDIR /etc/nginx

COPY deploy/nginx.prod.conf /etc/nginx/conf.d/default.conf
COPY deploy/nginx.http-only.conf /tmp/nginx.http-only.conf
RUN if [ "$HTTP_ONLY" = "true" ]; then mv /tmp/nginx.http-only.conf /etc/nginx/conf.d/default.conf; else rm /tmp/nginx.http-only.conf; fi
COPY --from=builder /app/dist /usr/share/nginx/html

# Webroot for Certbot HTTP-01 challenge
RUN mkdir -p /var/www/certbot

EXPOSE 80 443

CMD ["nginx", "-g", "daemon off;"]
