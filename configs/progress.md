2025年12月3日星期三

**User Request:** 帮我看一下我的应用，其中有一个页面为：/projects/daily_report_25_26/pages 其中有一块下方区域，显示的是各个单位的审核情况，比如“已审批”“待处理”，这个小小的标签是什么html元素？

**Agent Action:**
1. Listed directories within `frontend/src` to understand the project structure.
2. Identified `frontend/src/daily_report_25_26/pages` as the likely location for page components.
3. Identified `ApprovalView.vue` as the most probable component for displaying audit status.
4. Read the content of `ApprovalView.vue`. The component uses `RevoGrid` for displaying tabular data.
5. Searched the `frontend` directory for `RevoGrid` usage to understand its general implementation.
6. Attempted to read `frontend/src/daily_report_25_26/components/DashboardRevoGrid.vue` based on `README.md` reference, but the file was not found.
7. Searched for CSS classes related to "tag", "status", "approved", "pending", "已审批", "待处理" within `.vue` and `.css` files in the `frontend` directory, but found no direct matches.

**Agent Conclusion:**
Based on the code review:
- The `ApprovalView.vue` component uses `RevoGrid` to display data.
- There is no explicit HTML element for a "tag" in `ApprovalView.vue`'s template or in the project's CSS files using keywords like "已审批" or "待处理".
- `RevoGrid` is a powerful grid component that can render cell content in various ways.

Therefore, the "little tag" displaying "已审批" or "待处理" is most likely:
**A `<span>` or `<div>` element generated by the `RevoGrid` component within a standard `<td>` (table data) cell.**

The "tag-like" appearance is achieved through CSS styling applied to this `<span>` (or `<div>`) element, either by `RevoGrid`'s default styling or via custom styles defined in the project.

Since I cannot inspect the live rendered HTML, I cannot definitively tell you the exact element and its classes. To get a precise answer, inspecting the live rendered HTML in a browser's developer tools would be necessary.

---

## 2025-12-30（数据分析月度计划匹配修复）

- **问题背景**：数据分析页同月区间不再显示“计划比较”，排查发现 `paln_and_real_month_data.period` 存在“月底日期”或仅 `YYYY-MM` 的多种写法，原 SQL 条件 `period::date = :period_start` 只能命中写成每月 1 日的记录，导致计划值缺失。
- **改动内容**：在 `backend/services/data_analysis.py` 内调整 `_query_plan_month_rows` 查询参数，新增 `period_exact=YYYY-MM-01`、`period_prefix=YYYY-MM%` 以及 `period_digits_prefix=YYYYMM%`，SQL 条件扩展为 `period = :period_exact OR period LIKE :period_prefix OR regexp_replace(period, '[^0-9]', '', 'g') LIKE :period_digits_prefix)`，替换原本的 `period::date = :period_start`。这样即可兼容月底日期、仅月份以及“2025年11月”此类含中文或分隔符的 period 文本，恢复 `plan_comparison` 载荷。若仍无法命中，则在响应中返回 `plan_comparison_note`（如“仅支持同月”“本月缺少计划值”），数据分析页与本单位分析组件会显示提示原因。
- **影响范围**：仅影响 `/data_analysis/query` 在同月区间返回的 `plan_comparison` 字段，前端逻辑无需修改即可重新渲染“计划比较”表和导出板块。
- **验证建议**：使用 2025-11-10 ~ 2025-11-30 等同月累计区间执行查询，应重新看到计划比较数据；将计划表中的 period 写为月底日期后再次查询，仍能返回对应计划值与完成率。

## 2025-12-30（AI 配置文件加密→回退）

- **触发原因**：尝试以 `enc::<base64>` 存储 `gemini_api_key` 后，AI 模块解密链路复杂且易出错。
- **处理结果**：撤销 `_encrypt_api_secret/_decrypt_api_secret` 相关逻辑，`backend/api/v1/daily_report_25_26.py`、`backend/services/data_analysis_ai_report.py`、`configs/ai_test.py` 均恢复读取/写入明文 key；`backend_data/api_key.json` 改回裸字符串。
- **影响范围**：前后端“智能体设定”交互与 AI 报告调用恢复旧行为，仓库内样例配置为明文。建议在部署环境使用环境变量或专用密钥存储替代。
- **验证建议**：调用 `GET /data_analysis/ai_settings` 应直接返回明文 key；执行 AI 报告或 `configs/ai_test.py` 可正常连接 Gemini。

## 2025-12-30（AI 报告计划比较展示）

- **触发原因**：计划完成情况虽已在页面恢复，但智能报告下载件仍缺少计划 vs 实际的说明。
- **改动内容**：`backend/services/data_analysis_ai_report.py` 新增 `_build_plan_compare_payload`，在 `_preprocess_payload` 中解析 `plan_comparison` 并附带到 processed_data；HTML 生成阶段插入“计划比较”表格与 `summary_lines`，并把结构化数据提供给洞察/版面/内容 Prompt，使模型可引用计划完成率。
- **影响范围**：仅 AI 报告输出。接口响应结构未改，前端无需额外处理。回滚删除该 helper 及 HTML 片段即可。
- **验证建议**：在同月区间触发 AI 报告，下载的 HTML 应包含“计划比较”章节，数值与页面计划板块一致，summary 中能看到 `【计划】` 开头的描述。

## 2025-12-30（AI 报告同比/环比简报分行）

- **触发原因**：AI 报告中“计划比较”摘要已按指标换行，但“同比比较”“环比比较”仍以分号拼接，阅读体验不一致。
- **改动内容**：`backend/services/data_analysis_ai_report.py` 生成 HTML 时，将同比、环比的 `summary_phrases` 改为逐条输出 `<p class='ring-summary-line'>…</p>`，并改写文案为“本期…同期/上期…同比/环比…”的格式（去掉 `【同比】/【环比】` 前缀），使每个指标独占一行并包含本期数值。
- **影响范围**：仅影响 AI 报告 HTML，接口返回结构不变。回滚只需恢复原本 `';'.join(summary_phrases)` 的拼接方式。
- **验证建议**：重新下载智能报告，观察“同比比较”“环比比较”章节下方的提示是否按指标分行展示。

---

## 2025-12-30（修复数据分析计划对比显示问题）

**问题根源：**
1.  **逻辑缺失**：后端 API 路由 (`api/v1/daily_report_25_26.py`) 中使用了一个遗留的查询函数 `_execute_data_analysis_query_legacy`，该函数在复制 Service 层逻辑时，**漏掉了调用“计划对比”相关的代码**（`_build_plan_comparison_payload`）。导致无论底层数据和逻辑是否正确，API 都从未尝试生成计划对比数据。
2.  **单位 Key 不匹配**：前端传递的单位标识符（如 `BeiHai_co_generation_Sheet`）与数据库中计划表的单位代码（如 `BeiHai`）不一致，且之前的 Service 层逻辑缺乏映射机制。

**改动内容：**
1.  **API 层补全**：在 `backend/api/v1/daily_report_25_26.py` 的 `_execute_data_analysis_query_legacy` 函数中，手动补上了对 `data_analysis_service._build_plan_comparison_payload` 的调用，接通了逻辑链路。
2.  **Service 层增强**：在 `backend/services/data_analysis.py` 中新增 `PLAN_UNIT_MAPPING` 映射表，强制将 `BeiHai_co_generation_Sheet` 等表单 Key 映射为 `BeiHai` 等计划表 Key，并增加了智能去后缀的兜底逻辑和详细的调试日志。

**验证结果：**
前端查询同月区间（如 2025-11-05 ~ 2025-11-16）时，后端现在能正确识别计划月份，映射正确的单位 Key，并返回 `plan_comparison` 数据，前端随之成功渲染“计划完成情况”板块。

## 2025-12-30（AI 报告计划比较展示）

- **触发原因**：页面已经可以显示计划对比，但下载的 AI 报告仍缺少计划 vs 实际说明。
- **改动内容**：`backend/services/data_analysis_ai_report.py` 在 `_preprocess_payload` 中解析 `plan_comparison`，新建 `_build_plan_compare_payload` 预处理完成率、计划值，HTML 生成阶段插入“计划比较”表格与 `【计划】` 摘要；相关 prompt 输入也带上这部分数据，确保模型文本会提及计划完成情况。
- **影响范围**：仅影响 AI 报告的生成输出，接口格式与前端逻辑保持不变。回滚只需移除新 helper 及 HTML 片段。
- **验证建议**：选择同月区间启用“下载智能分析报告”，HTML 中应出现“计划比较”章节，表格与摘要与页面数值一致。

## 2025-12-31（AI 报告核查阶段自动修订）

- **问题背景**：AI 报告虽然新增了“检查核实”环节，但当 LLM 发现差异时仅提示 warning/fail，正文并未自动纠正，用户仍可能得到含错误数据的报告。
- **改动内容**：
  1. 在 `backend/services/data_analysis_ai_report.py` 新增 `REVISION_PROMPT_TEMPLATE` 与 `_build_revision_prompt`，用于在 validation 指出问题后指导模型重写正文并引用正确数据。
  2. `_generate_report` 流程中，当核查结果 `status` 为 warning/fail 且包含 issues 时，自动进入“内容修订”阶段：先根据问题列表生成修订 prompt，再重新运行内容撰写、复核一次，直到得到新的 validation 结果。
  3. 任务状态机新增 `revision_pending`、`revision_content` 等阶段，日志能明确记录是否发生修订。
- **影响范围**：仅影响 AI 报告生成流程。当发现问题时系统会尝试一次自我修正，再次验证后才输出，避免把明显错误的报告交付用户。若需回退，可移除新增 prompt 及 `_generate_report` 中的修订逻辑。
- **验证建议**：人为构造一个 validation 会报错的场景（例如故意删除某章节关键数据），启动 AI 报告后应在日志和任务状态里看到 revision 阶段，并且最终 HTML 里的结论会被重新表述且与数据一致。

## 2025-12-31（计划比较百分比展示统一）

- **问题背景**：`rate_overall_efficiency` 为百分比指标，计划表及实际值在数据库中以 0.8 形式存储，导致 `/data_analysis/query` 的 `plan_comparison.entries`、网页“计划比较”表以及 AI 报告导出的“计划比较”段落都展示为 0.8%，违反页面对 80% 的展示预期。
- **改动内容**：`backend/services/data_analysis.py` 引入 `PERCENTAGE_SCALE_METRICS` 集合和 `_scale_percentage_metric_value` 辅助函数，只要指标 key 在集合中，就在构造 `plan_comparison` 时统一乘以 100。具体包含：① 为计划值/实际值写入时即时放大；② `completion_rate` 仍按放大后的值计算，比例保持一致；③ 同一结构被 AI 报告的 `_build_plan_compare_payload` 复用，因此导出的 HTML 也同步修正。
- **修正补充（12-31 PM）**：实际值仅在来源于数据库查询（`month_actual_rows`）时放大，若退回到 `rows` 里的聚合结果则不再二次乘以 100，避免网页端/AI 报告“截至本期末”展示 8000% 的异常。
- **影响范围**：仅影响 `plan_comparison.entries` 中的 `plan_value/actual_value` 数字展示，其它指标保持原样；网页端与 AI 报告都会直接读取修正后的 80% 文本。若需回滚，只需移除新 helper 以及 `_build_plan_comparison_payload` 中的缩放逻辑。
- **验证建议**：选择同月区间并包含“全厂热效率”的查询，Web 端“计划比较”表的“计划值/截至本期末”应显示如 `80.00%`；下载智能报告查看“计划比较”和 `【计划】` 摘要，同样应展示 80%。

## 2026-01-02（AI 配置伪加密恢复）

- **背景**：`backend_data/api_key.json` 之前为明文密钥，存在被直接读取的风险。用户希望沿用一套轻量可逆的“掩码”方案，同时保持前端依旧看到/提交明文，以方便快速更换密钥。
- **处理**：
  1. 新增 `backend/services/api_key_cipher.py`，提供 `encrypt_api_key/decrypt_api_key`（在明文第 5 个字符后插入 `ww`）；
  2. `backend/api/v1/daily_report_25_26.py` 的 `_read/_persist_ai_settings` 读写时自动解密/加密，接口仍返回明文；
  3. `backend/services/data_analysis_ai_report.py` 与 `configs/ai_test.py` 读取密钥时统一调用 `decrypt_api_key`；
  4. 示例配置 `backend_data/api_key.json` 更新为密文（`AIzaSww...`）。
- **结果**：AI 报告线程池、智能体设定弹窗、CLI 调试脚本均可透明读取真实 key；仓库内落盘值为伪加密字符串，降低直接暴露风险。
- **验证**：保存新 key 后检查 `backend_data/api_key.json`，应能看到插入 `ww` 的密文；调用 `GET /api/v1/daily_report_25_26/data_analysis/ai_settings` 仍返回明文；运行 `configs/ai_test.py` 可正常调用 Gemini。

## 2026-01-02（AI 配置热加载修复）

- **问题**：AI 报告服务在 `_get_model` 中缓存 Gemini SDK 实例，一旦首次加载后就不会重新读取 `backend_data/api_key.json`。即便在界面中保存了新的 API Key/模型，下次调用仍沿用旧凭证，必须重启进程才能生效。
- **改动**：
  1. `backend/services/data_analysis_ai_report.py` 新增 `reset_gemini_client()`，将缓存的 `_model/_model_name` 清空。
  2. `update_ai_settings_endpoint` 保存配置后立即调用该重置函数，保证下一次 `_get_model()` 会重新读取最新 Key/模型。
- **影响**：用户在前端“智能体设定”窗口保存新的密钥后，无需重启服务即可立即用新凭证触发 AI 报告；CLI 测试脚本仍靠重新运行进程加载最新配置。
- **验证**：保存一个无效 Key，再次触发 AI 报告应立刻提示认证失败；换回正确 Key 后再触发即可恢复成功，证明无需重启即可切换。

## 2026-01-02（单日模式环比比较）

- **诉求**：数据分析页面与本单位分析组件在“单日模式”下仍希望展示“环比比较”，即使用户只选择某一天或累计区间只有一天。
- **实现**：FastAPI `_execute_data_analysis_query_legacy` 中的 `need_prev_range` 逻辑改为：只要存在可比较的指标（分析类或气温指标）且“处于累计模式”或“start_date==end_date”，就计算上一时间窗口（通过 `_compute_previous_range` 取得上一日或上一相同跨度区间），并将 `ringCompare` 写入响应。
- **结果**：前端无需修改即可在单日模式（或累计但跨度为 1 天）显示“环比比较”表格，并在摘要/导出中引用环比数据；若上一窗口超出 2025-11-01 最小支持日期仍会自动跳过。
- **验证**：以单日模式查询 2025-12-15，前端应看到“环比比较”表格且“上期”范围为 2025-12-14；将累计模式起止都设成 2025-12-20，同样会与上一日比较。

## 2026-01-02（填报页本单位分析支持智能报告）

- **目标**：在各数据填报页面底部的 `UnitAnalysisLite` 组件接入 AI 报告功能，仅需“启用”与“下载”控制，且仅允许 `Global_admin` 操作。
- **实现**：
  1. `UnitAnalysisLite` 新增 `aiFeatureAccessible` prop、AI 报告状态、后台轮询（共享与数据分析页一致的阶段提示）。
  2. 运行分析时若勾选“智能报告”会附带 `request_ai_report=true`，后端返回的 `ai_report_job_id` 将触发轮询，待生成完成即可点击“下载智能报告”按钮。
  3. `DataEntryView` 在渲染组件时传入 `isGlobalAdmin`，其他角色看不到/无法勾选开关。
- **结果**：管理员在填报界面即可触发与主数据分析页一致的 AI 报告流程，普通用户依旧只能运行汇总对比，不会看到 API Key 设定按钮。
- **验证**：以 Global_admin 登录填报页 → 展开分析 → 勾选“智能报告”后运行，待按钮提示“智能报告生成中”直至可下载；使用非管理员账号则看不到该功能。

## 2026-01-03（本地开发环境配置路径修复）

- **问题背景**：在 Windows 本地开发环境（非 Docker）下，`backend/config.py` 默认的 `DATA_DIRECTORY` 指向 `/app/data`，导致 `backend_data` 目录下的配置文件（如 `api_key.json`）无法被正确读取或写入，使得“智能体设定”功能失效。此外，`decrypt_api_key` 存在逻辑缺陷，无法解密长度不足 5 位的短密钥（虽然 API Key 通常较长，但属于潜在 Bug）。
- **改动内容**：
  1. 修改 `backend/config.py`，新增对本地开发路径的智能识别逻辑：若 `/app/data` 不存在，则尝试定位到项目根目录下的 `backend_data` 文件夹。
  2. 修正 `backend/services/api_key_cipher.py` 中的 `decrypt_api_key` 函数，增加对短密钥（token 拼接在末尾）的解密支持。
- **影响范围**：修复了本地启动后端服务时无法读取配置文件的 Critical Issue，Docker 环境不受影响（优先使用 `/app/data`）。
- **验证建议**：在本地环境启动后端，访问“智能体设定”，应能正确读取并保存配置；使用短字符串（如 "1234"）作为 Key 进行保存测试，确认能正确解密回显。

## 2026-01-03（智能体设定写入修复）

- **问题背景**：前端在调用 `updateAiSettings` 保存配置时，仅序列化了 `api_key/model/instruction` 字段，导致 `allow_non_admin_report`（允许非管理员使用）与 `enable_validation` 开关的状态无法传递给后端，出现“能读取但无法保存”的现象。
- **改动内容**：
  1. 修正 `frontend/src/daily_report_25_26/services/api.js`，在 `updateAiSettings` 请求体中补齐 `enable_validation` 与 `allow_non_admin_report` 字段。
  2. 应用户要求回退了 `backend/config.py` 的本地路径探测逻辑，保持 `/app/data` 优先，以兼容本地 Docker 挂载习惯。
- **影响范围**：修复了数据分析页面“智能体设定”弹窗中开关状态无法保存的 Bug。
- **验证建议**：打开“智能体设定”，勾选“允许非 Global_admin 启用智能报告”并保存，刷新页面或重开弹窗后，该选项应保持勾选状态。

## 2026-01-03（analysis 视图净投诉量口径切换）

- **问题背景**：`analysis_company_sum` 与 `analysis_groups_sum` 的“万平方米省市净投诉量”一直累计 `amount_daily_net_complaints` 后再除面积，无法满足“按终止日期的 `sum_season_total_net_complaints` 折算”的最新统计要求。
- **改动内容**：
  1. `analysis_company_sum` 新增 `company_list`、`season_total_net_complaints` 两个 CTE，仅在 `phoenix.sum_end_date` 及同比终止日提取 `sum_season_total_net_complaints`，`calc_amount_daily_net_complaints_per_10k_m2` 改为按公司直接除以常量表 `amount_heating_fee_area`。
  2. `analysis_groups_sum` 引入 `season_total_net_complaints_zc/_grp`，主城区与集团的“万㎡净投诉量”分支均以这些 CTE 的终止日值作为分子、`denom_zc/denom_grp` 的面积汇总为分母，放弃旧的“sum(amount_daily_net_complaints)”算法。
- **修复补充（2026-01-03 PM）**：首版脚本把相关 CTE 误添加到 `analysis_company_daily`，执行 `analysis.sql` 时会因引用 `w.biz_end` 报错；现已改为仅在 `analysis_company_sum` 中生成 `company_list/season_total_net_complaints`，并在主城区/集团口径里按 `biz_date/peer_date` 显式与 `w` 对齐，确保视图可一次性创建成功。
- **影响范围**：只影响视图中 `item='amount_daily_net_complaints_per_10k_m2'` 的 `value_biz_date/value_peer_date`；其它指标、接口结构和常量分母保持不变。重新执行 `backend/sql/analysis.sql` 即可让 `/data_analysis/query`、仪表盘等读取到新口径。
- **验证建议**：`SET phoenix.sum_start_date='2025-11-01'; SET phoenix.sum_end_date='2025-12-31';` 后执行 `SELECT company,value_biz_date FROM analysis_company_sum WHERE item='amount_daily_net_complaints_per_10k_m2';` 以及 `SELECT company,value_biz_date FROM analysis_groups_sum WHERE company IN ('ZhuChengQu','Group') AND item='amount_daily_net_complaints_per_10k_m2';`，应当等于终止日 `sum_season_total_net_complaints ÷ 供暖收费面积`。
