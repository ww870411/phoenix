
• 前置说明
                                                                                                                                                                                                         
  - 我先梳理后端当前的“镜像查询”实现，重点聚焦“基本指标表”（standard/daily）这组表的 /query 机制、为什么这样设计、各环节怎么工作，以及可能破损的点。                                                     
  - 参考代码主入口：backend/api/v1/daily_report_25_26.py:1556 的 query_sheet。该路由挂载在项目前缀下：backend/api/v1/routes.py:177（/api/v1/projects/daily_report_25_26/...）。                          
                                                                                                                                                                                                         
  整体流程（/query）                                                                                                                                                                                     
                                                                                                                                                                                                         
  - 路由：POST /api/v1/projects/daily_report_25_26/data_entry/sheets/{sheet_key}/query                                                                                                                   
  - 主函数：backend/api/v1/daily_report_25_26.py:1556 query_sheet                                                                                                                                        
  - 核心思路：与 /submit 的落库路径“互逆”。即“提交如何写库”，查询就“按同一规则把库中记录反解回模板的格子”。                                                                                              
                                                                                                                                                                                                         
  关键步骤                                                                                                                                                                                               
                                                                                                                                                                                                         
  - 模板与类型识别                                                                                                                                                                                       
      - 解析 sheet_key，读取该表模板，识别模板类型 template_type（standard/crosstab/constant）。用于决定后续数据回填策略。                                                                               
      - 用到的工具函数：                                                                                                                                                                                 
          - 模板收集：backend/api/v1/daily_report_25_26.py:1388 _collect_catalog（读取并汇总模板/字典映射）                                                                                              
  - 统一的 Tall Table 读取                                                                                                                                                                               
      - DB 读取 entries（Tall Table），按唯一键/索引过滤：project_key + sheet_key + biz_date (+ 可选 company/period)                                                                                     
      - 目的：拿到这一天这个表的所有单元格数据（数值或文本）作为原始素材。                                                                                                                               
  - 规范化与对齐                                                                                                                                                                                         
      - 行标签规范化：把“模板里的行项名称”与“数据库记录中的 row_label”进行一致化。使用内部的字典映射组（别名归一）保证“提交时”和“查询时”采用同一套规范，避免“发电量/发电量(万kWh)”之类的命名偏差导致对   
        不上。                                                                                                                                                                                           
          - 相关常量/方法：                                                                                                                                                                              
              - backend/api/v1/daily_report_25_26.py:176 DICT_KEY_GROUPS（按组管理别名集合）                                                                                                             
              - 读取/归一化相关函数：_extract_mapping、_coerce_mapping、_collect_catalog 等（该文件内多处使用）                                                                                          
      - 列对齐：根据模板 columns 定位“从第几列开始是可填报列（含日期列/期间列）”，并据此计算数据库里每条记录对应的 col_index。                                                                           
      - 备注列处理：若模板包含“备注/说明”类列，构造它的列索引，将数据库中的 text 型数据映射到备注列。                                                                                                    
  - 结果形态（和模板镜像）                                                                                                                                                                               
      - standard/daily（基本指标表）：返回 cells（稀疏的单元格数组；前端据 row_label + col_index 回填）                                                                                                  
          - 形如：                                                                                                                                                                                       
              - {"row_label":"发电量","unit":"万kWh","col_index":2,"value_type":"num","value_num":123.4}                                                                                                 
          - 同时返回 columns（可能包含日期占位符替换后的列头），便于前端对齐列名。                                                                                                                       
      - crosstab（如 Coal_inventory_Sheet）：返回 rows（二维数组）+ columns（二维标题），尽量保持和模板结构一致，便于前端一次性渲染出交叉表。                                                            
      - constant：按“常量表”语义（无 biz_date/跨日期），查询后也走 cells，但过滤条件不同（不依赖 biz_date）。                                                                                            
                                                                                                                                                                                                         
  为什么这样设计                                                                                                                                                                                         
                                                                                                                                                                                                         
  - 互逆性（对称原则）                                                                                                                                                                                   
      - 既然 /submit 采用 Tall Table 扁平入库（五元组唯一键），/query 就按同一键/同一规范“反解”。这样能保证幂等和可读性：同一单元格重复提交不会新增多行，查询永远是唯一落点。                            
  - 规范化与对齐                                                                                                                                                                                         
      - 行标签/别名归一：解决“模板写法/用户口径/历史数据中的异名”对不上模板的问题。把“异名→规范名”统一在一处（字典），提交/查询两端共用，消除黑箱。                                                      
  - 类型分支清晰                                                                                                                                                                                         
      - standard（基本指标表）与 crosstab（交叉表）在结构上天然不同（后者本质上“列是维度”，查询更适合直接产出 2D 数组）。因此区分类型，避免到前端再做复杂转置。                                          
  - 稀疏传输，最小负载                                                                                                                                                                                   
      - standard 用 cells（稀疏）而不是全量 2D，避免大量空字符串 IO。前端只需要根据 row_label 和 col_index 回填即可。                                                                                    
                                                                                                                                                                                                         
  基本指标表（standard/daily）当前实现要点                                                                                                                                                               
                                                                                                                                                                                                         
  - 查询入口：query_sheet 根据模板识别为 standard，执行以下流程：                                                                                                                                        
      - 读取模板 columns 和 rows；从 rows 的第一列提取“行标签列表”，建立 label → rowIndex 的映射表（row_map）。                                                                                          
      - 计算“可编辑列起始索引”，并检测“备注列索引”（若存在“备注”“说明”等关键字）。                                                                                                                       
      - 从 DB 拉取 entries 记录，逐条规范化：                                                                                                                                                            
          - 行标签：用别名字典做一次 canonical 化（与 submit 同逻辑）。                                                                                                                                  
          - 列索引：按模板 columns 推导（遇到“按日期生成列名”的模板，会先替换占位符为真实日期，保证列数和索引稳定）。                                                                                    
          - 数值/文本：按 value_type、value_num/value_text 分流；备注类优先归到备注列。                                                                                                                  
      - 返回：                                                                                                                                                                                           
          - columns：和模板一致（含动态日期列）                                                                                                                                                          
          - cells：扁平数组（row_label + col_index + value_type + 值）                                                                                                                                   
  - 前端如何使用（参考说明）                                                                                                                                                                             
      - DataEntryView.vue 在 standard 分支中，会用 columns 更新列头，并用 cells 逐格回填到 gridSource（通过 row_label 找 ri，通过 col_index 找 ci）。                                                    
                                                                                                                                                                                                         
  目前可能破损/导致“看起来像 query 问题”的环节                                                                                                                                                           
                                                                                                                                                                                                         
  - 列头时间占位符未对齐                                                                                                                                                                                 
      - 模板 columns 里包含按日期生成的列名；如果查询端与模板端使用的“日期基准”不统一（比如前端先替了，但后端没按同样的基准重建 columns），会出现列数/列名不一致，导致前端无法对齐、回填失败，表面看就   
        是“query 查到了数据但网格是空的”。                                                                                                                                                               
  - 行标签归一不一致                                                                                                                                                                                     
      - 若某次“修正”变更了别名字典/归一规则，只在 submit 路径更新，未同步到 query 路径，就会出现 DB 里落的是 A（旧标签归一），查询时按 B（新标签归一）去找行，结果 row_map 找不到，cells 被丢弃。        
  - 备注列/文本列识别偏差                                                                                                                                                                                
      - 模板“备注”列名称调整、或被占位逻辑覆盖，导致后端无法识别这是备注列，从而把文本值当数值或直接丢弃，回填异常。                                                                                     
  - company/period 过滤条件                                                                                                                                                                              
      - 基本指标表部分带有“单位/期间”概念，如果前端传参与落库维度不一致（比如落库用了 company，但查询没带/公司名映射变化），会查不到记录，返回 cells 为空。                                              
                                                                                                                                                                                                         
  与 Coal_inventory_Sheet 的区别（方便横向理解）                                                                                                                                                         
                                                                                                                                                                                                         
  - Coal 为 crosstab：后端返回 rows（二维数组）+ columns，不是 cells。前端不做 row_label 匹配，而是直接按二维数组渲染。                                                                                  
  - 基本指标表为 standard：后端返回 cells；前端用 row_label+col_index 定位回填。                                                                                                                         
  - 如果 Coal 没带 template_type=crosstab 被当作 standard 跑，前端就会错误地按 cells 流程回填，基本等于“查到了也对不上”。                                                                                
                                                                                                                                                                                                         
  为什么感觉“本来好用，现在问题很多”                                                                                                                                                                     
                                                                                                                                                                                                         
  - 近期调整点多，容易出现“单边更新”：例如新增了一处归一规则/列名策略，但只改了 submit 或 template，不改 query；或者只改了前端 placeholder 替换，不改后端 columns 重建。                                 
  - 这类“互逆”逻辑的稳定性，依赖“抽出统一的规范化函数，并被 submit 与 query 两端共同调用”。任何一端脱节，就会像看起来“query 出了问题”。                                                                  
                                                                                                                                                                                                         
  建议的修复策略                                                                                                                                                                                         
                                                                                                                                                                                                         
  - 明确标准化入口                                                                                                                                                                                       
      - 把“行标签归一”“单位/company 映射”“日期→列生成”“备注列检测”提炼为独立的小函数，确保 submit/query/template 三处都用同一实现。当前已部分存在（如 _collect_catalog、DICT_KEY_GROUPS 系列），需要系统 
        梳理“谁在用、谁没用到”。                                                                                                                                                                         
  - columns 与日期占位符一处生效                                                                                                                                                                         
      - 约定 columns 的“日期替换基准”（来自请求体的 biz_date，或模板的默认日期），确保 query 在返回时 columns 与当次 template 完全一致。避免“列名不一致导致前端对不上”。                                 
  - 加入“对齐校验与诊断输出”                                                                                                                                                                             
      - 在 query 构造结果返回前，输出（日志/调试模式）：                                                                                                                                                 
          - 模板 rows 数、columns 数                                                                                                                                                                     
          - 从 DB 拿到的记录数                                                                                                                                                                           
          - 归一后匹配成功的 cells 数、无法匹配（row/col 不存在）的丢弃数                                                                                                                                
      - 这样能快速识别“行标签对不上/列名不一致”的根因。                                                                                                                                                  
  - 为“基本指标表”补两条单元测试                                                                                                                                                                         
      - 用一份最小化模板和两条 DB 记录，验证 /submit → /query → 与模板对齐 的镜像属性。                                                                                                                  
  - 前后端联动检查                                                                                                                                                                                       
      - 前端 DataEntryView 中，对 standard 分支只在收到 q.columns 后才更新 gridColumns，更新顺序和占位替换基准与后端一致，避免首屏被“后续初始化重置”。                                                   
                                                                                                                                                                                                         
  你现在最关心的黑箱细节（落点到代码/流程）                                                                                                                                                              
                                                                                                                                                                                                         
  - 查询入口：backend/api/v1/daily_report_25_26.py:1556 query_sheet                                                                                                                                      
  - 字典与映射：backend/api/v1/daily_report_25_26.py:176 DICT_KEY_GROUPS 及围绕模板/字典读取的 _collect_catalog、_extract_mapping 等                                                                     
  - 形态决定：                                                                                                                                                                                           
      - standard：返回 columns + cells（按 row_label+col_index 回填）                                                                                                                                    
      - crosstab：返回 columns + rows（二维）                                                                                                                                                            
      - constant：返回 cells，无 biz_date 过滤或使用不同维度                                                                                                                                             
  - 设计动机：严格“镜像 submit”，统一规范化，减少前端负担；用字典做别名归一，确保历史/模板/口径不一致时也能对齐；类型分支清晰，降低前端转换难度。                                                        
                                                                                                                                                                                                         
  如果你愿意，我可以立刻：                                                                                                                                                                               
                                                                                                                                                                                                         
  - 把“基本指标表”的行标签归一、备注列检测与日期列生成，抽成复用函数，并在 submit/query/template 三端对齐调用；                                                                                          
  - 给“基本指标表”补一条端到端的最小化单测（模拟两条记录、一次查询），验证真实 columns 下的 cells 回填；                                                                                                 
  - 在 query_sheet 增加“对齐诊断日志”（仅开发模式），打印 unmatched 行/列统计，方便你本地快速看到“是不是对不齐”。       